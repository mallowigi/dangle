/*! dangle-donut - v1.0.9 - 2014-11-03
* https://github.com/mallowigi/dangle.donut
* Copyright (c) 2014 FullScale Labs, LLC; Licensed  */
angular.module("dangle.donut",[]).factory("fsDonutData",function(){"use strict";return{isHighlighted:!1,highlightedTerm:"",hoveredTerm:""}}).directive("fsDonut",["fsDonutData",function(e){"use strict";return{restrict:"E",scope:{outerRadius:"=",innerRadius:"=",fontSize:"=",fontColor:"=",domain:"=",colorMap:"=",onClick:"=",bind:"=",duration:"@",showLabels:"@",opacity:"@"},controller:["$scope",function(t){t.donutData=e}],link:function(t,n,r){var i=t.outerRadius||200,s=t.innerRadius||0,o=t.fontSize||14,u=r.fontColor||"#fff",a,f=t.showLabels==="true",l=t.opacity||.5;angular.isUndefined(r.field)&&(r.field=r.bind.split(".").pop().toLowerCase()),t.colorMap===undefined?(a=d3.scale.category20c(),t.domain!==undefined&&a.domain(t.domain)):a=function(e){return t.colorMap[e]};var c=i*3+30,h=i*3,p=d3.svg.arc().outerRadius(i-10).innerRadius(s),d=d3.layout.pie().sort(null).value(function(e){return e.count}),v=d3.select(n[0]).append("svg").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+c+" "+h).attr("class","fs-donut"),m=v.append("g").attr("transform","translate("+c/2+","+h/2+") rotate(180) scale(-1, -1)"),g=v.append("g").attr("class","label_group").attr("transform","translate("+c/2+","+h/2+")");t.$watch("bind",function(s){function h(e,t){var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){return p(t(e))}}function y(e,t){var n=(this._current.startAngle+this._current.endAngle-Math.PI)/2,r=(e.startAngle+e.endAngle-Math.PI)/2,s=d3.interpolateNumber(n,r);return function(e){var t=s(e);return"translate("+Math.cos(t)*(i+w)+","+Math.sin(t)*(i+w)+")"}}var c=t.duration||0,b=function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"},w=14;if(s){s=s.terms||[];var E=d(s),S=0;for(var x=0;x<s.length;x++)S+=s[x].count;if(S>0){var T=m.selectAll("path").data(E);T.enter().append("path").attr("d",p).attr("stroke","#fff").attr("stroke-width","1.5").attr("cursor","pointer").attr("class",function(e){return"fs-arc fs-arc-"+e.data.term.toLowerCase()}).style("fill",function(e){return a(e.data.term)}).each(function(e){this._current=e}).on("mouseenter",function(t){n.find(".fs-arc").css({opacity:l}),n.find(".fs-arc-"+t.data.term.toLowerCase()).css({opacity:1}),e.hoveredTerm=t.data.term}).on("mouseleave",function(t){e.isHighlighted?(n.find(".fs-arc").css({opacity:l}),n.find(".fs-arc-"+e.highlightedTerm.toLowerCase()).css({opacity:1})):n.find(".fs-arc").css({opacity:1}),e.hoveredTerm=""}).on("mousedown",function(e){t.$apply(function(){(t.onClick||angular.noop)(r.field,e.data.term)})}),T.style("fill",function(e){return a(e.data.term)}).transition().duration(c).attrTween("d",h).style("fill",function(e){return a(e.data.term)}),T.exit().remove();if(f){var N=g.selectAll("line").data(E);N.enter().append("line").attr("x1",0).attr("x2",0).attr("y1",-i-3).attr("y2",-i-8).attr("stroke",u).attr("stroke-width",2).attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"}).each(function(e){this._current=e}),N.transition().duration(c).attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"}),N.exit().remove();var C=g.selectAll("text.value").data(E).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?17:-17}).attr("text-anchor",b).text(function(e){var t=e.value/S*100;return t.toFixed(1)+"%"});C.enter().append("text").attr("class","value").attr("font-size",o).attr("font-weight","bold").attr("transform",function(e){return"translate("+Math.cos((e.startAngle+e.endAngle-Math.PI)/2)*(i+w)+","+Math.sin((e.startAngle+e.endAngle-Math.PI)/2)*(i+w)+")"}).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?17:-17}).attr("text-anchor",b).text(function(e){var t=e.value/S*100;return t.toFixed(1)+"%"}).each(function(e){this._current=e}),C.transition().duration(c).attrTween("transform",y),C.exit().remove();var k=g.selectAll("text.units").data(E).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?36:2}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).text(function(e){return e.data.term==="T"?"TRUE ("+e.value+")":e.data.term==="F"?"FALSE ("+e.value+")":e.data.term+" ("+e.value+")"});k.enter().append("text").attr("class","units").attr("font-size",16).attr("stroke","none").attr("fill","#000").attr("transform",function(e){return"translate("+Math.cos((e.startAngle+e.endAngle-Math.PI)/2)*(i+w)+","+Math.sin((e.startAngle+e.endAngle-Math.PI)/2)*(i+w)+")"}).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?36:2}).attr("text-anchor",b).text(function(e){return e.data.term==="T"?"TRUE ("+e.value+")":e.data.term==="F"?"FALSE ("+e.value+")":e.data.term+" ("+e.value+")"}).each(function(e){this._current=e}),k.transition().duration(c).attrTween("transform",y),k.exit().remove()}}else v.selectAll("path").remove(),g.selectAll("line").remove(),g.selectAll("text.value").remove(),g.selectAll("text.units").remove()}}),t.$watch("donutData.hoveredTerm",function(t,r){if(e.isHighlighted)return;t!==r&&(t?(n.find(".fs-arc").css({opacity:l}),n.find(".fs-arc-"+t.toLowerCase()).css({opacity:1})):n.find(".fs-arc").css({opacity:1}))}),t.$watch("donutData.highlightedTerm",function(t,r){if(!e.isHighlighted)return;t!==r&&(n.find(".fs-arc").css({opacity:l}),n.find(".fs-arc-"+t.toLowerCase()).css({opacity:1}))}),t.$watch("donutData.isHighlighted",function(e){e===!1&&n.find(".fs-arc").css({opacity:1})})}}}]);