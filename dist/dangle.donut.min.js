/*! dangle - v1.0.0 - 2014-10-26
* http://www.fullscale.co/dangle
* Copyright (c) 2014 FullScale Labs, LLC; Licensed MIT */
angular.module("dangle.donut",[]).directive("fsDonut",[function(){"use strict";return{restrict:"E",scope:{outerRadius:"=",innerRadius:"=",fontSize:"=",fontColor:"=",domain:"=",colorMap:"=",onClick:"=",bind:"=",duration:"@",showLabels:"@"},link:function(e,t,n){var r=e.outerRadius||200,i=e.innerRadius||0,s=e.fontSize||14,o=n.fontColor||"#fff",u=undefined,a=e.showLabels||!0;n.field==undefined&&(n.field=n.bind.split(".").pop().toLowerCase()),e.colorMap===undefined?(u=d3.scale.category20c(),e.domain!==undefined&&u.domain(e.domain)):u=function(t){return e.colorMap[t]};var f=r*3+30,l=r*3,c=d3.svg.arc().outerRadius(r-10).innerRadius(i),h=d3.layout.pie().sort(null).value(function(e){return e.count}),p=d3.select(t[0]).append("svg").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+f+" "+l),d=p.append("g").attr("transform","translate("+f/2+","+l/2+") rotate(180) scale(-1, -1)"),v=p.append("g").attr("class","label_group").attr("transform","translate("+f/2+","+l/2+")");e.$watch("bind",function(t){function a(e,t){var t=d3.interpolate(this._current,e);return this._current=t(0),function(e){return c(t(e))}}function f(e,t){var n=(this._current.startAngle+this._current.endAngle-Math.PI)/2,i=(e.startAngle+e.endAngle-Math.PI)/2,s=d3.interpolateNumber(n,i);return function(e){var t=s(e);return"translate("+Math.cos(t)*(r+m)+","+Math.sin(t)*(r+m)+")"}}var i=e.duration||0,l=function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"},m=14;if(t){t=t.terms||[];var g=h(t),y=0;for(var b=0;b<t.length;b++)y+=t[b].count;if(y>0){var w=d.selectAll("path").data(g);w.enter().append("path").attr("d",c).attr("stroke","#fff").attr("stroke-width","1.5").attr("cursor","pointer").style("fill",function(e){return u(e.data.term)}).each(function(e){this._current=e}).on("mousedown",function(t){e.$apply(function(){(e.onClick||angular.noop)(n.field,t.data.term)})}),w.style("fill",function(e){return u(e.data.term)}).transition().duration(i).attrTween("d",a).style("fill",function(e){return u(e.data.term)}),w.exit().remove();if(e.showLabels){var E=v.selectAll("line").data(g);E.enter().append("line").attr("x1",0).attr("x2",0).attr("y1",-r-3).attr("y2",-r-8).attr("stroke",o).attr("stroke-width",2).attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"}).each(function(e){this._current=e})}E.transition().duration(i).attr("transform",function(e){return"rotate("+(e.startAngle+e.endAngle)/2*(180/Math.PI)+")"}),E.exit().remove();if(e.showLabels){var S=v.selectAll("text.value").data(g).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?17:-17}).attr("text-anchor",l).text(function(e){var t=e.value/y*100;return t.toFixed(1)+"%"});S.enter().append("text").attr("class","value").attr("font-size",s).attr("font-weight","bold").attr("transform",function(e){return"translate("+Math.cos((e.startAngle+e.endAngle-Math.PI)/2)*(r+m)+","+Math.sin((e.startAngle+e.endAngle-Math.PI)/2)*(r+m)+")"}).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?17:-17}).attr("text-anchor",l).text(function(e){var t=e.value/y*100;return t.toFixed(1)+"%"}).each(function(e){this._current=e}),S.transition().duration(i).attrTween("transform",f),S.exit().remove();var x=v.selectAll("text.units").data(g).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?36:2}).attr("text-anchor",function(e){return(e.startAngle+e.endAngle)/2<Math.PI?"beginning":"end"}).text(function(e){return e.data.term==="T"?"TRUE ("+e.value+")":e.data.term==="F"?"FALSE ("+e.value+")":e.data.term+" ("+e.value+")"});x.enter().append("text").attr("class","units").attr("font-size",16).attr("stroke","none").attr("fill","#000").attr("transform",function(e){return"translate("+Math.cos((e.startAngle+e.endAngle-Math.PI)/2)*(r+m)+","+Math.sin((e.startAngle+e.endAngle-Math.PI)/2)*(r+m)+")"}).attr("dy",function(e){return(e.startAngle+e.endAngle)/2>Math.PI/2&&(e.startAngle+e.endAngle)/2<Math.PI*1.5?36:2}).attr("text-anchor",l).text(function(e){return e.data.term==="T"?"TRUE ("+e.value+")":e.data.term==="F"?"FALSE ("+e.value+")":e.data.term+" ("+e.value+")"}).each(function(e){this._current=e}),x.transition().duration(i).attrTween("transform",f),x.exit().remove()}}else p.selectAll("path").remove(),v.selectAll("line").remove(),v.selectAll("text.value").remove(),v.selectAll("text.units").remove()}})}}}]);